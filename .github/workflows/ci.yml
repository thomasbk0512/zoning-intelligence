name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  backend:
    name: Backend (Python) checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect Python project
        id: py
        run: |
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        if: steps.py.outputs.present == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        if: steps.py.outputs.present == 'true' && hashFiles('requirements.txt') != ''
        run: pip install -r requirements.txt

      - name: Run tests (pytest)
        if: steps.py.outputs.present == 'true' && hashFiles('tests/**/*.py') != ''
        run: pytest -q

      - name: No Python project found — skipping
        if: steps.py.outputs.present == 'false'
        run: echo "No Python files (requirements.txt/pyproject.toml) — skipping backend job."

  ui:
    name: UI (Node) checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect UI project
        id: ui
        run: |
          if [ -f "ui/package.json" ] || [ -f "package.json" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
            # choose base path
            if [ -f "ui/package.json" ]; then echo "base=ui" >> "$GITHUB_OUTPUT"; else echo "base=." >> "$GITHUB_OUTPUT"; fi
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node
        if: steps.ui.outputs.present == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: |
            ${{ steps.ui.outputs.base }}/package-lock.json
            ${{ steps.ui.outputs.base }}/pnpm-lock.yaml
            ${{ steps.ui.outputs.base }}/yarn.lock

      - name: Install
        if: steps.ui.outputs.present == 'true'
        working-directory: ${{ steps.ui.outputs.base }}
        run: |
          if [ -f pnpm-lock.yaml ]; then npm i -g pnpm && pnpm i --frozen-lockfile; \
          elif [ -f yarn.lock ]; then yarn install --frozen-lockfile; \
          else npm ci || npm i; fi

      - name: Test
        if: steps.ui.outputs.present == 'true' && (hashFiles(format('{0}/**/*', steps.ui.outputs.base)) != '')
        working-directory: ${{ steps.ui.outputs.base }}
        run: |
          if npm run -s test >/dev/null 2>&1; then npm test --silent || true; else echo "No test script — skipping"; fi

      - name: Build
        if: steps.ui.outputs.present == 'true'
        working-directory: ${{ steps.ui.outputs.base }}
        run: |
          if npm run -s build >/dev/null 2>&1; then npm run build || true; else echo "No build script — skipping"; fi

      - name: No UI project found — skipping
        if: steps.ui.outputs.present == 'false'
        run: echo "No package.json found in repo or /ui — skipping UI job."

      - name: Emit metrics
        if: steps.py.outputs.present == 'true'
        run: |
          if [ -f "zoning/scripts/emit_metrics.py" ]; then
            python3 zoning/scripts/emit_metrics.py --output metrics.json || echo "Metrics emission failed, continuing"
          else
            echo "Metrics script not found, creating placeholder"
            echo '{"ts":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","parcels_processed":0,"rules_applied":0,"total_runtime_ms":0,"errors_count":0}' > metrics.json
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: observability-artifacts
          path: |
            cache/logs/**
            metrics.json
            ui/lhci/**
          retention-days: 7
          if-no-files-found: ignore

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    if: env.E2E_ENABLE == 'true'
    env:
      E2E_ENABLE: ${{ vars.E2E_ENABLE || 'false' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Playwright
        working-directory: ui
        run: |
          npm ci
          npx playwright install --with-deps
      - name: Run E2E tests
        working-directory: ui
        run: |
          npm run test:e2e || echo "E2E tests not yet implemented"
        continue-on-error: true

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    if: env.LH_ENABLE == 'true'
    env:
      LH_ENABLE: ${{ vars.LH_ENABLE || 'false' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Lighthouse CI
        working-directory: ui
        run: |
          npm ci
          npm install -g @lhci/cli
      - name: Build UI
        working-directory: ui
        run: npm run build
      - name: Run Lighthouse CI
        working-directory: ui
        run: |
          lhci autorun || echo "Lighthouse CI not yet configured"
        continue-on-error: true
