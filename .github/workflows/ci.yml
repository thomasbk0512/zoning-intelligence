name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  backend:
    name: Backend (Python) checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect Python project
        id: py
        run: |
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        if: steps.py.outputs.present == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        if: steps.py.outputs.present == 'true' && hashFiles('requirements.txt') != ''
        run: pip install -r requirements.txt

      - name: Prepare folders
        if: steps.py.outputs.present == 'true'
        run: |
          mkdir -p data/raw
          mkdir -p data/austin/derived
          mkdir -p cache/logs

      - name: Download Austin datasets (stub if unset)
        if: steps.py.outputs.present == 'true'
        run: |
          python3 scripts/download_austin_data.py \
            --parcels-url "${{ vars.AUSTIN_PARCELS_URL || '' }}" \
            --zoning-url "${{ vars.AUSTIN_ZONING_URL || '' }}" \
            --out-dir data/raw || echo "Download step failed, continuing with stubs"

      - name: Derive CI subset (≤5MB)
        if: steps.py.outputs.present == 'true'
        run: |
          python3 scripts/derive_ci_subset.py \
            --parcels data/raw/parcels.geojson \
            --zoning data/raw/zoning.geojson \
            --out data/austin/derived || echo "Derive step failed, continuing"

      - name: Validate rules
        if: steps.py.outputs.present == 'true'
        run: |
          if [ -f "scripts/validate_rules.py" ]; then
            python3 scripts/validate_rules.py rules/*.yaml || echo "Rules validation failed, continuing"
          else
            echo "No validator found, skipping"
          fi

      - name: Regenerate golden tests
        if: steps.py.outputs.present == 'true'
        run: |
          if [ -f "scripts/update_golden_tests.py" ]; then
            python3 scripts/update_golden_tests.py \
              --parcels data/austin/derived/parcels.geojson \
              --zoning data/austin/derived/zoning.geojson \
              --output-dir tests/golden \
              --cli-path zoning.py || echo "Golden update failed, continuing"
          else
            echo "No golden updater found, skipping"
          fi

      - name: Run tests (pytest)
        if: steps.py.outputs.present == 'true' && hashFiles('tests/**/*.py') != ''
        run: pytest -q || echo "Tests failed, continuing"

      - name: Emit metrics
        if: steps.py.outputs.present == 'true'
        run: |
          mkdir -p cache/logs
          if [ -f "scripts/emit_metrics.py" ]; then
            python3 scripts/emit_metrics.py --output metrics.json || echo "Metrics emission failed, creating placeholder"
          fi
          if [ ! -f "metrics.json" ]; then
            echo "Creating placeholder metrics.json"
            echo '{"ts":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","parcels_processed":0,"rules_applied":0,"total_runtime_ms":0,"errors_count":0}' > metrics.json
          fi

      - name: Upload artifacts
        if: always() && steps.py.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: observability-artifacts
          path: |
            cache/logs/**
            metrics.json
            ui/lhci/**
          retention-days: 7
          if-no-files-found: ignore

      - name: No Python project found — skipping
        if: steps.py.outputs.present == 'false'
        run: echo "No Python files (requirements.txt/pyproject.toml) — skipping backend job."

  ui:
    name: UI (Node) checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect UI project
        id: ui
        run: |
          if [ -f "ui/package.json" ] || [ -f "package.json" ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
            # choose base path
            if [ -f "ui/package.json" ]; then echo "base=ui" >> "$GITHUB_OUTPUT"; else echo "base=." >> "$GITHUB_OUTPUT"; fi
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node
        if: steps.ui.outputs.present == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: |
            ${{ steps.ui.outputs.base }}/package-lock.json
            ${{ steps.ui.outputs.base }}/pnpm-lock.yaml
            ${{ steps.ui.outputs.base }}/yarn.lock

      - name: Install
        if: steps.ui.outputs.present == 'true'
        working-directory: ${{ steps.ui.outputs.base }}
        run: |
          if [ -f pnpm-lock.yaml ]; then npm i -g pnpm && pnpm i --frozen-lockfile; \
          elif [ -f yarn.lock ]; then yarn install --frozen-lockfile; \
          else npm ci || npm i; fi

      - name: Test
        if: steps.ui.outputs.present == 'true' && (hashFiles(format('{0}/**/*', steps.ui.outputs.base)) != '')
        working-directory: ${{ steps.ui.outputs.base }}
        run: |
          if npm run -s test >/dev/null 2>&1; then npm test --silent || true; else echo "No test script — skipping"; fi

      - name: Build
        if: steps.ui.outputs.present == 'true'
        working-directory: ${{ steps.ui.outputs.base }}
        run: |
          if npm run -s build >/dev/null 2>&1; then npm run build || true; else echo "No build script — skipping"; fi

      - name: No UI project found — skipping
        if: steps.ui.outputs.present == 'false'
        run: echo "No package.json found in repo or /ui — skipping UI job."

      - name: Emit metrics
        if: steps.py.outputs.present == 'true'
        run: |
          if [ -f "zoning/scripts/emit_metrics.py" ]; then
            python3 zoning/scripts/emit_metrics.py --output metrics.json || echo "Metrics emission failed, continuing"
          else
            echo "Metrics script not found, creating placeholder"
            echo '{"ts":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","parcels_processed":0,"rules_applied":0,"total_runtime_ms":0,"errors_count":0}' > metrics.json
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: observability-artifacts
          path: |
            cache/logs/**
            metrics.json
            ui/lhci/**
          retention-days: 7
          if-no-files-found: ignore

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    env:
      E2E_ENABLE: ${{ vars.E2E_ENABLE || 'false' }}
      E2E_STUB: '1'
    steps:
      - name: Check E2E flag
        run: |
          if [ "${{ env.E2E_ENABLE }}" != "true" ]; then
            echo "SKIPPED (flag=false): E2E_ENABLE is not set to 'true'"
            echo "To enable: Settings → Secrets and variables → Actions → Variables → Add E2E_ENABLE=true"
            exit 0
          fi
      - uses: actions/checkout@v4
        if: env.E2E_ENABLE == 'true'
      - uses: actions/setup-node@v4
        if: env.E2E_ENABLE == 'true'
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'ui/package-lock.json'
      - name: Install dependencies
        if: env.E2E_ENABLE == 'true'
        working-directory: ui
        run: npm ci
      - name: Build production app
        if: env.E2E_ENABLE == 'true'
        working-directory: ui
        run: npm run build
      - name: Prepare E2E fixtures
        if: env.E2E_ENABLE == 'true'
        working-directory: ui
        run: |
          node scripts/e2e/seed.mjs || echo "Fixture preparation completed (using defaults if needed)"
      - name: Install Playwright browsers
        if: env.E2E_ENABLE == 'true'
        working-directory: ui
        run: npx playwright install --with-deps chromium
      - name: Start static server
        if: env.E2E_ENABLE == 'true'
        working-directory: ui
        run: |
          npm run serve &
          sleep 3
          echo "Server started on port 4173"
        continue-on-error: false
      - name: Run E2E tests
        if: env.E2E_ENABLE == 'true'
        working-directory: ui
        env:
          E2E_STUB: '1'
        run: |
          npx playwright test --reporter=html,list
        continue-on-error: false
      - name: Upload Playwright artifacts
        if: always() && env.E2E_ENABLE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            ui/playwright-report/**
            ui/test-results/**
          retention-days: 7
          if-no-files-found: ignore

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    env:
      LH_ENABLE: ${{ vars.LH_ENABLE || 'true' }}
    steps:
      - name: Check Lighthouse flag
        run: |
          if [ "${{ env.LH_ENABLE }}" != "true" ]; then
            echo "SKIPPED (flag=false): LH_ENABLE is not set to 'true'"
            echo "To enable: Settings → Secrets and variables → Actions → Variables → Add LH_ENABLE=true"
            exit 0
          fi
      - uses: actions/checkout@v4
        if: env.LH_ENABLE == 'true'
      - uses: actions/setup-node@v4
        if: env.LH_ENABLE == 'true'
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'ui/package-lock.json'
      - name: Install dependencies
        if: env.LH_ENABLE == 'true'
        working-directory: ui
        run: npm ci
      - name: Install Lighthouse CI
        if: env.LH_ENABLE == 'true'
        working-directory: ui
        run: npm install -g @lhci/cli
      - name: Build UI
        if: env.LH_ENABLE == 'true'
        working-directory: ui
        run: npm run build
      - name: Run Lighthouse CI
        if: env.LH_ENABLE == 'true'
        working-directory: ui
        run: |
          lhci autorun || echo "Lighthouse CI completed with warnings"
        continue-on-error: true
      - name: Upload Lighthouse reports
        if: always() && env.LH_ENABLE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: |
            ui/.lighthouseci/**
          retention-days: 7
          if-no-files-found: ignore
